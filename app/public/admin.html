<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>lilyco42 Â· ç®¡ç†åå°</title>
<link rel="preconnect" href="https://fonts.googleapis.cnpmjs.org">
<link rel="icon" href="./icon/favicon.ico" type="image/x-icon" />
<link href="https://fonts.googleapis.cnpmjs.org/css2?family=DM+Mono:wght@400;500&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d0d0f;
  --panel:#141416;
  --panel2:#1c1c1f;
  --border:#26262b;
  --border2:#333338;
  --text:#e8e6e0;
  --text2:#888;
  --text3:#555;
  --green:#3ecf8e;
  --yellow:#f5a623;
  --red:#e5484d;
  --blue:#6eb5ff;
  --purple:#b17cf5;
  --accent:#e8c97e;
  --r:10px;
}
html{background:var(--bg);color:var(--text);font-family:'Noto Sans SC',sans-serif;font-size:13px;-webkit-font-smoothing:antialiased}
body{display:flex;min-height:100vh}
button{cursor:pointer;border:none;font-family:inherit}
a{color:inherit;text-decoration:none}
img{display:block}
input,select,textarea{font-family:inherit;outline:none}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{
  width:220px;flex-shrink:0;
  background:var(--panel);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  position:sticky;top:0;height:100vh;
  overflow:hidden;
}
.sidebar-logo{
  padding:20px 20px 16px;
  border-bottom:1px solid var(--border);
}
.sidebar-logo .name{
  font-family:'DM Mono',monospace;
  font-size:.85rem;color:var(--accent);letter-spacing:.5px;
}
.sidebar-logo .sub{font-size:11px;color:var(--text3);margin-top:2px}

.nav-section{padding:12px 10px 0;flex:1;overflow-y:auto}
.nav-label{font-size:10px;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;padding:0 10px;margin-bottom:6px;margin-top:12px}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:8px 10px;border-radius:8px;
  color:var(--text2);cursor:pointer;
  transition:all .15s;font-size:13px;
  user-select:none;
}
.nav-item:hover{background:var(--panel2);color:var(--text)}
.nav-item.active{background:rgba(232,201,126,.1);color:var(--accent)}
.nav-item .icon{width:18px;text-align:center;font-size:14px;flex-shrink:0}
.nav-item .badge{margin-left:auto;background:var(--red);color:#fff;border-radius:10px;padding:1px 7px;font-size:10px;font-family:'DM Mono',monospace}

.sidebar-bottom{
  padding:14px;
  border-top:1px solid var(--border);
  font-size:12px;color:var(--text3);
}
.sidebar-bottom .user{display:flex;align-items:center;gap:8px;color:var(--text2)}
.sidebar-bottom .av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#b87070,#8b5e5e);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}

/* â”€â”€ Main â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* Topbar */
.topbar{
  height:52px;display:flex;align-items:center;gap:12px;
  padding:0 24px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.topbar-title{font-size:14px;font-weight:700;color:var(--text)}
.topbar-breadcrumb{font-size:12px;color:var(--text3)}
.topbar-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.topbar-search{
  display:flex;align-items:center;gap:0;
  background:var(--panel2);border:1px solid var(--border);
  border-radius:8px;padding:0 10px;
  transition:border-color .15s;
}
.topbar-search:focus-within{border-color:var(--border2)}
.topbar-search input{background:none;border:none;color:var(--text);font-size:12px;padding:7px 0;width:180px}
.topbar-search input::placeholder{color:var(--text3)}

/* â”€â”€ Content â”€â”€ */
.content{flex:1;overflow-y:auto;padding:24px}

/* â”€â”€ Page sections â”€â”€ */
.page{display:none}
.page.active{display:block}

/* â”€â”€ Stats cards â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.stat-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:var(--r);padding:16px;
  transition:border-color .15s;
}
.stat-card:hover{border-color:var(--border2)}
.stat-card .label{font-size:11px;color:var(--text3);margin-bottom:8px;letter-spacing:.3px}
.stat-card .value{font-size:1.6rem;font-family:'DM Mono',monospace;font-weight:500;line-height:1}
.stat-card .sub{font-size:11px;color:var(--text3);margin-top:4px}
.stat-card.green .value{color:var(--green)}
.stat-card.yellow .value{color:var(--yellow)}
.stat-card.red .value{color:var(--red)}
.stat-card.blue .value{color:var(--blue)}
.stat-card.purple .value{color:var(--purple)}
.stat-card.accent .value{color:var(--accent)}

/* â”€â”€ Toolbar â”€â”€ */
.toolbar{display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
.tab-group{display:flex;background:var(--panel);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.tab-btn{
  padding:6px 14px;border:none;background:none;
  color:var(--text2);font-size:12px;font-family:inherit;
  transition:all .15s;
}
.tab-btn.active,.tab-btn:hover{background:var(--panel2);color:var(--text)}
.tab-btn.active{color:var(--accent);font-weight:500}
.ml-auto{margin-left:auto}

.btn{
  padding:6px 14px;border-radius:7px;font-size:12px;font-family:inherit;
  display:inline-flex;align-items:center;gap:5px;
  transition:all .15s;
}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--text2)}
.btn-ghost:hover{border-color:var(--border2);color:var(--text)}
.btn-green{background:rgba(62,207,142,.12);border:1px solid rgba(62,207,142,.25);color:var(--green)}
.btn-green:hover{background:rgba(62,207,142,.2)}
.btn-red{background:rgba(229,72,77,.12);border:1px solid rgba(229,72,77,.25);color:var(--red)}
.btn-red:hover{background:rgba(229,72,77,.2)}
.btn-accent{background:rgba(232,201,126,.12);border:1px solid rgba(232,201,126,.25);color:var(--accent)}
.btn-accent:hover{background:rgba(232,201,126,.2)}

/* â”€â”€ Table â”€â”€ */
.table-wrap{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
table{width:100%;border-collapse:collapse}
thead th{
  padding:10px 14px;text-align:left;
  font-size:11px;color:var(--text3);font-weight:500;
  letter-spacing:.4px;text-transform:uppercase;
  border-bottom:1px solid var(--border);
  white-space:nowrap;
}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(255,255,255,.02)}
tbody td{padding:10px 14px;vertical-align:middle;font-size:13px}

.cell-img{display:flex;align-items:center;gap:10px}
.thumb{
  width:44px;height:44px;border-radius:6px;
  object-fit:cover;background:var(--panel2);flex-shrink:0;
  border:1px solid var(--border);
}
.cell-title{font-weight:500;color:var(--text);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cell-sub{font-size:11px;color:var(--text3);margin-top:2px}

.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:500}
.badge-pending{background:rgba(245,166,35,.12);color:var(--yellow);border:1px solid rgba(245,166,35,.2)}
.badge-approved{background:rgba(62,207,142,.12);color:var(--green);border:1px solid rgba(62,207,142,.2)}
.badge-rejected{background:rgba(229,72,77,.12);color:var(--red);border:1px solid rgba(229,72,77,.2)}
.badge-admin{background:rgba(177,124,245,.12);color:var(--purple);border:1px solid rgba(177,124,245,.2)}
.badge-user{background:rgba(110,181,255,.12);color:var(--blue);border:1px solid rgba(110,181,255,.2)}
.badge-banned{background:rgba(229,72,77,.12);color:var(--red);border:1px solid rgba(229,72,77,.2)}
.badge-active{background:rgba(62,207,142,.12);color:var(--green);border:1px solid rgba(62,207,142,.2)}

.actions-cell{display:flex;gap:5px;flex-wrap:nowrap}

/* â”€â”€ Pagination â”€â”€ */
.pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-top:1px solid var(--border)}
.page-info{font-size:12px;color:var(--text3)}
.page-btns{display:flex;gap:4px}
.page-btn{
  width:28px;height:28px;border-radius:6px;border:1px solid var(--border);
  background:none;color:var(--text2);font-size:12px;font-family:'DM Mono',monospace;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.page-btn:hover{border-color:var(--border2);color:var(--text)}
.page-btn.active{background:var(--accent);color:#1a1a1a;border-color:var(--accent);font-weight:600}
.page-btn:disabled{opacity:.35;pointer-events:none}

/* â”€â”€ Image review panel â”€â”€ */
.review-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.review-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;position:relative;
  transition:border-color .15s;
}
.review-card.selected{border-color:var(--accent)}
.review-card img{width:100%;aspect-ratio:1;object-fit:cover;background:var(--panel2)}
.review-card .rc-body{padding:10px}
.review-card .rc-title{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.review-card .rc-meta{font-size:11px;color:var(--text3)}
.review-card .rc-actions{display:flex;gap:6px;margin-top:8px}
.review-card .rc-actions .btn{flex:1;justify-content:center;padding:5px}
.select-box{
  position:absolute;top:8px;left:8px;
  width:18px;height:18px;border-radius:4px;
  border:2px solid rgba(255,255,255,.4);
  background:rgba(0,0,0,.4);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .15s;
}
.review-card.selected .select-box{background:var(--accent);border-color:var(--accent);color:#1a1a1a}

/* â”€â”€ Modal â”€â”€ */
.modal-bg{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px}
.modal-bg.on{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:24px;width:100%;max-width:420px;position:relative;box-shadow:0 24px 64px rgba(0,0,0,.5)}
.modal-title{font-size:15px;font-weight:700;margin-bottom:16px;color:var(--text)}
.modal-close{position:absolute;top:16px;right:18px;background:none;border:none;color:var(--text3);font-size:18px;line-height:1;transition:color .15s}
.modal-close:hover{color:var(--text)}
.field{margin-bottom:12px}
.field label{display:block;font-size:11px;color:var(--text3);margin-bottom:5px;letter-spacing:.4px;text-transform:uppercase}
.field input,.field textarea,.field select{
  width:100%;padding:8px 11px;
  background:var(--panel2);border:1px solid var(--border);
  border-radius:7px;color:var(--text);font-size:13px;
  transition:border-color .15s;
}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--border2)}
.field textarea{resize:vertical;min-height:70px}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}

/* â”€â”€ Image preview modal â”€â”€ */
.preview-modal{max-width:700px}
.preview-img-wrap{background:var(--panel2);border-radius:8px;overflow:hidden;margin-bottom:14px;max-height:400px;display:flex;align-items:center;justify-content:center}
.preview-img-wrap img{max-width:100%;max-height:400px;object-fit:contain}
.preview-meta{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px}
.preview-meta .kv{display:flex;flex-direction:column;gap:2px}
.preview-meta .k{color:var(--text3);font-size:11px}
.preview-meta .v{color:var(--text);font-weight:500}

/* â”€â”€ Empty â”€â”€ */
.empty-state{padding:60px 20px;text-align:center;color:var(--text3)}
.empty-state .ei{font-size:40px;margin-bottom:10px}
.empty-state p{font-size:14px;color:var(--text2)}

/* â”€â”€ Toast â”€â”€ */
#toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast-item{
  background:var(--panel2);border:1px solid var(--border);
  border-radius:8px;padding:10px 16px;font-size:13px;color:var(--text);
  box-shadow:0 8px 24px rgba(0,0,0,.4);
  animation:slideIn .3s ease;
}
.toast-item.ok{border-color:rgba(62,207,142,.3);color:var(--green)}
.toast-item.err{border-color:rgba(229,72,77,.3);color:var(--red)}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€ Checkbox â”€â”€ */
input[type=checkbox]{accent-color:var(--accent);width:14px;height:14px;cursor:pointer}
</style>
</head>
<body>

<!-- â”€â”€ Sidebar â”€â”€ -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="name">ğŸ“Œ lilyco42</div>
    <div class="sub">ç®¡ç†åå°</div>
  </div>
  <nav class="nav-section">
    <div class="nav-label">æ€»è§ˆ</div>
    <div class="nav-item active" data-page="overview" onclick="goPage('overview',this)">
      <span class="icon">â—ˆ</span> æ•°æ®æ€»è§ˆ
    </div>

    <div class="nav-label">å†…å®¹ç®¡ç†</div>
    <div class="nav-item" data-page="review" onclick="goPage('review',this)">
      <span class="icon">â—</span> å›¾ç‰‡å®¡æ ¸
      <span class="badge" id="pendingBadge">0</span>
    </div>
    <div class="nav-item" data-page="images" onclick="goPage('images',this)">
      <span class="icon">â–¦</span> æ‰€æœ‰å›¾ç‰‡
    </div>

    <div class="nav-label">ç”¨æˆ·ç®¡ç†</div>
    <div class="nav-item" data-page="users" onclick="goPage('users',this)">
      <span class="icon">âŠ™</span> ç”¨æˆ·åˆ—è¡¨
    </div>
  </nav>
  <div class="sidebar-bottom">
    <div class="user">
      <div class="av" id="sideAv"></div>
      <div>
        <div style="color:var(--text);font-size:12px;font-weight:500" id="sideUname">â€”</div>
        <div style="font-size:10px;margin-top:1px">ç®¡ç†å‘˜</div>
      </div>
    </div>
    <a href="/index.html" style="display:block;margin-top:10px;color:var(--text3);font-size:11px;transition:color .15s" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--text3)'">â† è¿”å›å‰å°</a>
  </div>
</aside>

<!-- â”€â”€ Main â”€â”€ -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="pageTitle">æ•°æ®æ€»è§ˆ</div>
    <span class="topbar-breadcrumb" id="pageBreadcrumb"></span>
    <div class="topbar-right">
      <div class="topbar-search">
        <input type="text" id="topSearch" placeholder="æœç´¢â€¦" onkeydown="if(event.key==='Enter')doTopSearch()">
        <span style="color:var(--text3);font-size:14px">âŒ•</span>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- â•â• OVERVIEW â•â• -->
    <div class="page active" id="page-overview">
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card"><div class="label">æ€»ç”¨æˆ·</div><div class="value" id="s-users">â€”</div></div>
        <div class="stat-card blue"><div class="label">æ€»å›¾ç‰‡</div><div class="value" id="s-images">â€”</div></div>
        <div class="stat-card yellow"><div class="label">å¾…å®¡æ ¸</div><div class="value" id="s-pending">â€”</div></div>
        <div class="stat-card green"><div class="label">å·²é€šè¿‡</div><div class="value" id="s-approved">â€”</div></div>
        <div class="stat-card red"><div class="label">å·²æ‹’ç»</div><div class="value" id="s-rejected">â€”</div></div>
        <div class="stat-card accent"><div class="label">æ€»ç‚¹èµ</div><div class="value" id="s-likes">â€”</div></div>
        <div class="stat-card purple"><div class="label">æ”¶è—å¤¹</div><div class="value" id="s-collections">â€”</div></div>
        <div class="stat-card red"><div class="label">å°ç¦ç”¨æˆ·</div><div class="value" id="s-banned">â€”</div></div>
        <div class="stat-card green"><div class="label">ä»Šæ—¥ä¸Šä¼ </div><div class="value" id="s-today-up">â€”</div><div class="sub">å¼ </div></div>
        <div class="stat-card blue"><div class="label">ä»Šæ—¥æ–°ç”¨æˆ·</div><div class="value" id="s-today-usr">â€”</div><div class="sub">äºº</div></div>
      </div>
      <div style="color:var(--text3);font-size:12px;text-align:center;margin-top:40px">
        ç‚¹å‡»å·¦ä¾§èœå•å¼€å§‹ç®¡ç†
      </div>
    </div>

    <!-- â•â• REVIEW â•â• -->
    <div class="page" id="page-review">
      <div class="toolbar">
        <div class="tab-group">
          <button class="tab-btn active" data-status="pending" onclick="setReviewTab('pending',this)">å¾…å®¡æ ¸</button>
          <button class="tab-btn" data-status="approved" onclick="setReviewTab('approved',this)">å·²é€šè¿‡</button>
          <button class="tab-btn" data-status="rejected" onclick="setReviewTab('rejected',this)">å·²æ‹’ç»</button>
          <button class="tab-btn" data-status="all" onclick="setReviewTab('all',this)">å…¨éƒ¨</button>
        </div>
        <span style="font-size:12px;color:var(--text3)" id="reviewTotal"></span>
        <div class="ml-auto" style="display:flex;gap:6px">
          <button class="btn btn-green" onclick="batchReview('approve')">âœ“ æ‰¹é‡é€šè¿‡</button>
          <button class="btn btn-red"   onclick="batchReview('reject')">âœ• æ‰¹é‡æ‹’ç»</button>
          <button class="btn btn-ghost" onclick="selectAllReview()" id="selAllBtn">å…¨é€‰</button>
        </div>
      </div>

      <div class="review-grid" id="reviewGrid"></div>

      <div class="load-more" style="text-align:center;padding:24px 0" id="reviewLoadMore">
        <button class="btn btn-ghost" onclick="loadReview()" id="reviewLoadMoreBtn">åŠ è½½æ›´å¤š</button>
      </div>
    </div>

    <!-- â•â• IMAGES TABLE â•â• -->
    <div class="page" id="page-images">
      <div class="toolbar">
        <div class="tab-group">
          <button class="tab-btn active" data-status="all"      onclick="setImgTab('all',this)">å…¨éƒ¨</button>
          <button class="tab-btn" data-status="approved"  onclick="setImgTab('approved',this)">å·²é€šè¿‡</button>
          <button class="tab-btn" data-status="pending"   onclick="setImgTab('pending',this)">å¾…å®¡æ ¸</button>
          <button class="tab-btn" data-status="rejected"  onclick="setImgTab('rejected',this)">å·²æ‹’ç»</button>
        </div>
        <span style="font-size:12px;color:var(--text3)" id="imgTotal"></span>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>å›¾ç‰‡</th>
              <th>ä¸Šä¼ è€…</th>
              <th>çŠ¶æ€</th>
              <th>ç‚¹èµ</th>
              <th>æ–‡ä»¶å¤§å°</th>
              <th>ä¸Šä¼ æ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="imgTableBody"></tbody>
        </table>
        <div class="pagination" id="imgPagination"></div>
      </div>
    </div>

    <!-- â•â• USERS TABLE â•â• -->
    <div class="page" id="page-users">
      <div class="toolbar">
        <span style="font-size:12px;color:var(--text3)" id="userTotal"></span>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ç”¨æˆ·å</th>
              <th>é‚®ç®±</th>
              <th>è§’è‰²</th>
              <th>çŠ¶æ€</th>
              <th>å›¾ç‰‡æ•°</th>
              <th>æ³¨å†Œæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
        <div class="pagination" id="userPagination"></div>
      </div>
    </div>

  </div>
</div>

<!-- â•â• MODAL: æ‹’ç»åŸå›  â•â• -->
<div class="modal-bg" id="mReject">
  <div class="modal">
    <div class="modal-title">å¡«å†™æ‹’ç»åŸå› </div>
    <button class="modal-close" onclick="closeM('mReject')">âœ•</button>
    <div class="field">
      <label>åŸå› ï¼ˆå¯é€‰ï¼‰</label>
      <textarea id="rejectReason" placeholder="ä¾‹ï¼šå›¾ç‰‡è´¨é‡ä¸ç¬¦åˆè¦æ±‚ã€å†…å®¹è¿è§„â€¦" rows="3"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeM('mReject')">å–æ¶ˆ</button>
      <button class="btn btn-red" onclick="confirmReject()">ç¡®è®¤æ‹’ç»</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: å›¾ç‰‡é¢„è§ˆ â•â• -->
<div class="modal-bg" id="mPreview">
  <div class="modal preview-modal" style="max-width:700px">
    <button class="modal-close" onclick="closeM('mPreview')">âœ•</button>
    <div class="preview-img-wrap"><img id="previewImg" alt=""></div>
    <div class="preview-meta" id="previewMeta"></div>
    <div class="modal-actions" id="previewActions"></div>
  </div>
</div>

<div id="toast"></div>

<script>
const tk = () => localStorage.getItem('token');
const auth = () => ({ Authorization:`Bearer ${tk()}` });
const json = h => ({...h, 'Content-Type':'application/json'});

let me = null;
let reviewPage=1, reviewStatus='pending', reviewSelected=new Set(), reviewHasMore=true;
let imgPage=1, imgStatus='all', imgSearchQ='';
let userPage=1, userSearchQ='';
let rejectTarget=null; // { ids:[], single:false }
let previewImage=null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  if (!tk()) { location.href='/sign_in.html'; return; }
  const r = await fetch('/me', { headers:auth() });
  const d = await r.json();
  if (d.role !== 'admin') { alert('æ— ç®¡ç†å‘˜æƒé™'); location.href='/index.html'; return; }
  me = d;
  document.getElementById('sideUname').textContent = me.username;
  document.getElementById('sideAv').textContent    = me.username[0].toUpperCase();

  loadStats();
  document.querySelectorAll('.modal-bg').forEach(bg =>
    bg.addEventListener('click', e => { if (e.target===bg) bg.classList.remove('on'); })
  );
})();

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pageTitles = { overview:'æ•°æ®æ€»è§ˆ', review:'å›¾ç‰‡å®¡æ ¸', images:'æ‰€æœ‰å›¾ç‰‡', users:'ç”¨æˆ·åˆ—è¡¨' };
function goPage(name, el) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  el.classList.add('active');
  document.getElementById('pageTitle').textContent = pageTitles[name]||name;
  document.getElementById('pageBreadcrumb').textContent = '';
  document.getElementById('topSearch').value = '';

  if (name==='review')   { reviewPage=1; reviewSelected.clear(); loadReview(true); }
  if (name==='images')   { imgPage=1;    loadImages(); }
  if (name==='users')    { userPage=1;   loadUsers(); }
}

function doTopSearch() {
  const q = document.getElementById('topSearch').value.trim();
  const active = document.querySelector('.nav-item.active')?.dataset?.page;
  if (active==='images') { imgSearchQ=q; imgPage=1; loadImages(); }
  if (active==='users')  { userSearchQ=q; userPage=1; loadUsers(); }
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  const r = await fetch('/admin/stats', { headers:auth() });
  const d = await r.json();
  if (!d.stats) return;
  const s = d.stats;
  document.getElementById('s-users').textContent      = s.users;
  document.getElementById('s-images').textContent     = s.images;
  document.getElementById('s-pending').textContent    = s.pending;
  document.getElementById('s-approved').textContent   = s.approved;
  document.getElementById('s-rejected').textContent   = s.rejected;
  document.getElementById('s-likes').textContent      = s.likes;
  document.getElementById('s-collections').textContent= s.collections;
  document.getElementById('s-banned').textContent     = s.banned;
  document.getElementById('s-today-up').textContent   = s.today_uploads;
  document.getElementById('s-today-usr').textContent  = s.today_users;
  document.getElementById('pendingBadge').textContent = s.pending;
}

// â”€â”€ Review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setReviewTab(status, btn) {
  reviewStatus=status; reviewPage=1; reviewSelected.clear();
  document.querySelectorAll('.tab-btn').forEach(b=>{if(b.dataset.status)b.classList.remove('active')});
  btn.classList.add('active');
  loadReview(true);
}

async function loadReview(reset=false) {
  if (reset) { reviewPage=1; reviewHasMore=true; document.getElementById('reviewGrid').innerHTML=''; }
  if (!reviewHasMore) return;

  const r = await fetch(`/admin/images?status=${reviewStatus}&page=${reviewPage}&limit=24`, { headers:auth() });
  const d = await r.json();
  const imgs = d.images||[];

  document.getElementById('reviewTotal').textContent = `å…± ${d.total||0} å¼ `;

  if (imgs.length===0 && reviewPage===1) {
    document.getElementById('reviewGrid').innerHTML=`<div class="empty-state" style="column-span:all;grid-column:1/-1"><div class="ei">âœ“</div><p>æš‚æ— ${reviewStatus==='pending'?'å¾…å®¡æ ¸':''}å›¾ç‰‡</p></div>`;
  }

  imgs.forEach(img => {
    const card = document.createElement('div');
    card.className = 'review-card' + (reviewSelected.has(img.id)?' selected':'');
    card.dataset.id = img.id;
    card.innerHTML=`
      <div class="select-box" onclick="toggleSelect(${img.id},this.closest('.review-card'))">${reviewSelected.has(img.id)?'âœ“':''}</div>
      <img src="/uploads/${img.filename}" alt="" onclick="openPreview(${img.id})" loading="lazy" onerror="this.src=''">
      <div class="rc-body">
        <div class="rc-title">${esc(img.title||'æ— æ ‡é¢˜')}</div>
        <div class="rc-meta">@${esc(img.username)} Â· ${fmtDate(img.created_at)}</div>
        <div class="rc-actions" id="rcActions-${img.id}">
          ${reviewStatus==='pending'||reviewStatus==='all'?`
          <button class="btn btn-green" onclick="singleReview(${img.id},'approve')">âœ“ é€šè¿‡</button>
          <button class="btn btn-red"   onclick="openReject([${img.id}])">âœ• æ‹’ç»</button>
          `:''}
          ${reviewStatus==='approved'?`<button class="btn btn-red" onclick="singleReview(${img.id},'reject')">âœ• æ’¤å›</button>`:''}
          ${reviewStatus==='rejected'?`<button class="btn btn-green" onclick="singleReview(${img.id},'approve')">â†º é‡æ–°é€šè¿‡</button>`:''}
          <button class="btn btn-ghost" onclick="adminDeleteImg(${img.id})" style="flex:none">ğŸ—‘</button>
        </div>
      </div>`;
    document.getElementById('reviewGrid').appendChild(card);
  });

  if (imgs.length < 24) {
    reviewHasMore=false;
    document.getElementById('reviewLoadMoreBtn').textContent='å·²å…¨éƒ¨åŠ è½½';
    document.getElementById('reviewLoadMoreBtn').disabled=true;
  }
  reviewPage++;
}

function toggleSelect(id, card) {
  if (reviewSelected.has(id)) { reviewSelected.delete(id); card.classList.remove('selected'); card.querySelector('.select-box').textContent=''; }
  else { reviewSelected.add(id); card.classList.add('selected'); card.querySelector('.select-box').textContent='âœ“'; }
}

function selectAllReview() {
  const cards = document.querySelectorAll('.review-card');
  const allSelected = cards.length > 0 && [...cards].every(c=>reviewSelected.has(Number(c.dataset.id)));
  cards.forEach(c => {
    const id = Number(c.dataset.id);
    if (allSelected) { reviewSelected.delete(id); c.classList.remove('selected'); c.querySelector('.select-box').textContent=''; }
    else { reviewSelected.add(id); c.classList.add('selected'); c.querySelector('.select-box').textContent='âœ“'; }
  });
  document.getElementById('selAllBtn').textContent = allSelected ? 'å…¨é€‰' : 'å–æ¶ˆå…¨é€‰';
}

async function singleReview(id, action) {
  if (action==='reject') { openReject([id]); return; }
  const r = await fetch(`/admin/images/${id}/review`, { method:'POST', headers:json(auth()), body:JSON.stringify({action}) });
  const d = await r.json();
  if (d.success) {
    toast(`å·²${action==='approve'?'é€šè¿‡':'æ‹’ç»'}`, action==='approve'?'ok':'err');
    document.querySelector(`.review-card[data-id="${id}"]`)?.remove();
    loadStats();
  }
}

function openReject(ids) {
  rejectTarget = ids;
  document.getElementById('rejectReason').value='';
  openM('mReject');
}

async function confirmReject() {
  const reason = document.getElementById('rejectReason').value.trim();
  closeM('mReject');
  if (rejectTarget.length===1) {
    const r = await fetch(`/admin/images/${rejectTarget[0]}/review`, { method:'POST', headers:json(auth()), body:JSON.stringify({action:'reject',reason}) });
    const d = await r.json();
    if (d.success) { toast('å·²æ‹’ç»','err'); document.querySelector(`.review-card[data-id="${rejectTarget[0]}"]`)?.remove(); loadStats(); }
  } else {
    const r = await fetch('/admin/images/batch-review', { method:'POST', headers:json(auth()), body:JSON.stringify({ids:rejectTarget,action:'reject',reason}) });
    const d = await r.json();
    if (d.success) { toast(`å·²æ‹’ç» ${d.updated} å¼ `,'err'); rejectTarget.forEach(id=>document.querySelector(`.review-card[data-id="${id}"]`)?.remove()); reviewSelected.clear(); loadStats(); }
  }
}

async function batchReview(action) {
  if (!reviewSelected.size) { toast('è¯·å…ˆé€‰æ‹©å›¾ç‰‡','err'); return; }
  if (action==='reject') { openReject([...reviewSelected]); return; }
  const r = await fetch('/admin/images/batch-review', { method:'POST', headers:json(auth()), body:JSON.stringify({ids:[...reviewSelected],action}) });
  const d = await r.json();
  if (d.success) {
    toast(`å·²é€šè¿‡ ${d.updated} å¼ `, 'ok');
    reviewSelected.forEach(id=>document.querySelector(`.review-card[data-id="${id}"]`)?.remove());
    reviewSelected.clear();
    loadStats();
  }
}

async function adminDeleteImg(id) {
  if (!confirm('ç¡®è®¤åˆ é™¤è¿™å¼ å›¾ç‰‡ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
  const r = await fetch(`/admin/images/${id}`, { method:'DELETE', headers:auth() });
  const d = await r.json();
  if (d.success) { toast('å·²åˆ é™¤'); document.querySelector(`.review-card[data-id="${id}"]`)?.remove(); loadStats(); }
}

// â”€â”€ Images table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let imgTabStatus='all';
function setImgTab(status, btn) {
  imgTabStatus=status; imgPage=1;
  document.querySelectorAll('#page-images .tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  loadImages();
}

async function loadImages() {
  const q=imgSearchQ;
  const url=`/admin/images?status=${imgTabStatus}&page=${imgPage}&limit=20${q?'&q='+encodeURIComponent(q):''}`;
  const r = await fetch(url, { headers:auth() });
  const d = await r.json();
  const tbody = document.getElementById('imgTableBody');
  tbody.innerHTML='';
  document.getElementById('imgTotal').textContent=`å…± ${d.total||0} å¼ `;
  if (!d.images?.length) { tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">æš‚æ— æ•°æ®</td></tr>`; document.getElementById('imgPagination').innerHTML=''; return; }
  d.images.forEach(img => {
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <div class="cell-img">
          <img class="thumb" src="/uploads/${img.filename}" alt="" onclick="openImgPreview(${img.id})" style="cursor:pointer" onerror="this.src=''">
          <div>
            <div class="cell-title">${esc(img.title||'æ— æ ‡é¢˜')}</div>
            <div class="cell-sub">ID: ${img.id}</div>
          </div>
        </div>
      </td>
      <td style="color:var(--text2)">@${esc(img.username)}</td>
      <td><span class="badge badge-${img.status}">${{pending:'å¾…å®¡æ ¸',approved:'å·²é€šè¿‡',rejected:'å·²æ‹’ç»'}[img.status]||img.status}</span></td>
      <td style="font-family:'DM Mono',monospace;color:var(--text2)">${img.like_count||0}</td>
      <td style="color:var(--text3)">${fmtSize(img.file_size)}</td>
      <td style="color:var(--text3)">${fmtDate(img.created_at)}</td>
      <td>
        <div class="actions-cell">
          ${img.status!=='approved'?`<button class="btn btn-green" style="font-size:11px;padding:4px 9px" onclick="quickReview(${img.id},'approve')">é€šè¿‡</button>`:''}
          ${img.status!=='rejected'?`<button class="btn btn-red"   style="font-size:11px;padding:4px 9px" onclick="openReject([${img.id}])">æ‹’ç»</button>`:''}
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 9px" onclick="deleteImgTable(${img.id})">åˆ é™¤</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  renderPagination('imgPagination', imgPage, Math.ceil((d.total||0)/20), p=>{ imgPage=p; loadImages(); });
}

async function quickReview(id, action) {
  const r = await fetch(`/admin/images/${id}/review`, { method:'POST', headers:json(auth()), body:JSON.stringify({action}) });
  const d = await r.json();
  if (d.success) { toast(action==='approve'?'å·²é€šè¿‡':'å·²æ‹’ç»', action==='approve'?'ok':'err'); loadImages(); loadStats(); }
}

async function deleteImgTable(id) {
  if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
  const r = await fetch(`/admin/images/${id}`, { method:'DELETE', headers:auth() });
  const d = await r.json();
  if (d.success) { toast('å·²åˆ é™¤'); loadImages(); loadStats(); }
}

async function openImgPreview(id) {
  const r = await fetch(`/admin/images?status=all&q=`, { headers:auth() });
  // fetch single image details via the public endpoint
  const r2 = await fetch(`/images/${id}`, { headers:auth() });
  let img;
  if (r2.ok) { img = await r2.json(); }
  else {
    // fallback: find in table
    return;
  }
  previewImage = img;
  document.getElementById('previewImg').src = `/uploads/${img.filename}`;
  document.getElementById('previewMeta').innerHTML = `
    <div class="kv"><span class="k">æ ‡é¢˜</span><span class="v">${esc(img.title||'æ— æ ‡é¢˜')}</span></div>
    <div class="kv"><span class="k">ä¸Šä¼ è€…</span><span class="v">@${esc(img.username)}</span></div>
    <div class="kv"><span class="k">å°ºå¯¸</span><span class="v">${img.width||'?'} Ã— ${img.height||'?'}</span></div>
    <div class="kv"><span class="k">å¤§å°</span><span class="v">${fmtSize(img.file_size)}</span></div>
    <div class="kv"><span class="k">ç‚¹èµ</span><span class="v">${img.like_count||0}</span></div>
    <div class="kv"><span class="k">ä¸Šä¼ æ—¶é—´</span><span class="v">${fmtDate(img.created_at)}</span></div>
  `;
  document.getElementById('previewActions').innerHTML = `
    <button class="btn btn-ghost" onclick="closeM('mPreview')">å…³é—­</button>
    <button class="btn btn-red" onclick="deleteImgTable(${img.id});closeM('mPreview')">åˆ é™¤</button>
  `;
  openM('mPreview');
}

async function openPreview(id) {
  await openImgPreview(id);
}

// â”€â”€ Users table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers() {
  const q=userSearchQ;
  const url=`/admin/users?page=${userPage}&limit=20${q?'&q='+encodeURIComponent(q):''}`;
  const r = await fetch(url, { headers:auth() });
  const d = await r.json();
  const tbody = document.getElementById('userTableBody');
  tbody.innerHTML='';
  document.getElementById('userTotal').textContent=`å…± ${d.total||0} åç”¨æˆ·`;
  if (!d.users?.length) { tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3)">æš‚æ— æ•°æ®</td></tr>`; document.getElementById('userPagination').innerHTML=''; return; }
  d.users.forEach(u => {
    const tr=document.createElement('tr');
    const isSelf = u.id===me?.id;
    tr.innerHTML=`
      <td style="font-family:'DM Mono',monospace;color:var(--text3)">${u.id}</td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#b87070,#8b5e5e);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0">${u.username[0].toUpperCase()}</div>
          <span style="font-weight:500">${esc(u.username)}${isSelf?' <span style="font-size:10px;color:var(--text3)">(æˆ‘)</span>':''}</span>
        </div>
      </td>
      <td style="color:var(--text3)">${esc(u.email||'â€”')}</td>
      <td><span class="badge badge-${u.role}">${u.role==='admin'?'ç®¡ç†å‘˜':'æ™®é€šç”¨æˆ·'}</span></td>
      <td><span class="badge ${u.is_banned?'badge-banned':'badge-active'}">${u.is_banned?'å·²å°ç¦':'æ­£å¸¸'}</span></td>
      <td style="font-family:'DM Mono',monospace;color:var(--text2)">${u.image_count||0}</td>
      <td style="color:var(--text3)">${fmtDate(u.created_at)}</td>
      <td>
        ${!isSelf?`<div class="actions-cell">
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 9px" onclick="toggleBan(${u.id},${u.is_banned?0:1},'${esc(u.username)}')">${u.is_banned?'è§£å°':'å°ç¦'}</button>
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 9px" onclick="toggleRole(${u.id},'${u.role}','${esc(u.username)}')">${u.role==='admin'?'é™æƒ':'å‡ç®¡'}</button>
          <button class="btn btn-red"   style="font-size:11px;padding:4px 9px" onclick="deleteUser(${u.id},'${esc(u.username)}')">åˆ é™¤</button>
        </div>`:'<span style="color:var(--text3);font-size:11px">â€”</span>'}
      </td>`;
    tbody.appendChild(tr);
  });
  renderPagination('userPagination', userPage, Math.ceil((d.total||0)/20), p=>{ userPage=p; loadUsers(); });
}

async function toggleBan(id, ban, uname) {
  if (!confirm(`ç¡®è®¤${ban?'å°ç¦':'è§£å°'} @${uname}ï¼Ÿ`)) return;
  const r = await fetch(`/admin/users/${id}/ban`, { method:'POST', headers:json(auth()), body:JSON.stringify({ban:!!ban}) });
  const d = await r.json();
  if (d.success) { toast(`@${uname} å·²${ban?'å°ç¦':'è§£å°'}`, ban?'err':'ok'); loadUsers(); }
}

async function toggleRole(id, currentRole, uname) {
  const newRole = currentRole==='admin'?'user':'admin';
  if (!confirm(`ç¡®è®¤å°† @${uname} çš„æƒé™æ”¹ä¸º ${newRole==='admin'?'ç®¡ç†å‘˜':'æ™®é€šç”¨æˆ·'}ï¼Ÿ`)) return;
  const r = await fetch(`/admin/users/${id}/role`, { method:'POST', headers:json(auth()), body:JSON.stringify({role:newRole}) });
  const d = await r.json();
  if (d.success) { toast(`æƒé™å·²æ›´æ–°`, 'ok'); loadUsers(); }
}

async function deleteUser(id, uname) {
  if (!confirm(`ç¡®è®¤åˆ é™¤ç”¨æˆ· @${uname}ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ã€‚`)) return;
  const r = await fetch(`/admin/users/${id}`, { method:'DELETE', headers:auth() });
  const d = await r.json();
  if (d.success) { toast(`@${uname} å·²åˆ é™¤`); loadUsers(); loadStats(); }
}

// â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPagination(containerId, current, total, onPage) {
  const el = document.getElementById(containerId);
  if (total<=1) { el.innerHTML=''; return; }
  const start = Math.max(1, current-2), end = Math.min(total, current+2);
  let html = `<span class="page-info">ç¬¬ ${current} / ${total} é¡µ</span><div class="page-btns">`;
  html += `<button class="page-btn" ${current===1?'disabled':''} onclick="(${onPage.toString()})(${current-1})">â€¹</button>`;
  if (start>1) html+=`<button class="page-btn" onclick="(${onPage.toString()})(1)">1</button>${start>2?'<span style="color:var(--text3);padding:0 4px">â€¦</span>':''}`;
  for (let p=start;p<=end;p++) html+=`<button class="page-btn${p===current?' active':''}" onclick="(${onPage.toString()})(${p})">${p}</button>`;
  if (end<total) html+=`${end<total-1?'<span style="color:var(--text3);padding:0 4px">â€¦</span>':''}<button class="page-btn" onclick="(${onPage.toString()})(${total})">${total}</button>`;
  html+=`<button class="page-btn" ${current===total?'disabled':''} onclick="(${onPage.toString()})(${current+1})">â€º</button></div>`;
  el.innerHTML=html;
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openM(id)  { document.getElementById(id).classList.add('on'); }
function closeM(id) { document.getElementById(id).classList.remove('on'); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function fmtDate(s) { if(!s)return'â€”'; return new Date(s).toLocaleDateString('zh-CN',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
function fmtSize(b) { if(!b)return'â€”'; if(b<1024)return b+'B'; if(b<1024*1024)return(b/1024).toFixed(1)+'KB'; return(b/1024/1024).toFixed(2)+'MB'; }

let toastTimer;
function toast(msg, type='') {
  const wrap = document.getElementById('toast');
  const item = document.createElement('div');
  item.className='toast-item '+(type||'');
  item.textContent=msg;
  wrap.appendChild(item);
  setTimeout(()=>item.remove(), 3000);
}
</script>
</body>
</html>